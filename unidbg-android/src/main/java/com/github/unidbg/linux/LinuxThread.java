package com.github.unidbg.linux;

import com.github.unidbg.Emulator;
import com.github.unidbg.Module;
import com.github.unidbg.arm.ThreadDispatcher;
import com.github.unidbg.arm.backend.Backend;
import com.github.unidbg.debugger.Debugger;
import com.github.unidbg.pointer.UnidbgPointer;
import com.github.unidbg.unix.Thread;
import com.github.unidbg.unix.UnixThread;
import com.sun.jna.Pointer;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import unicorn.Arm64Const;
import unicorn.ArmConst;

public class LinuxThread extends UnixThread {



    private static final Log log = LogFactory.getLog(LinuxThread.class);

    // Our 'tls' and __pthread_clone's 'child_stack' are one and the same, just growing in
    // opposite directions.
    private final UnidbgPointer fn;
    private final Pointer arg;

    LinuxThread(Emulator<?> emulator,Pointer child_stack, Pointer fn, Pointer arg) {
        super(emulator.getBackend().context_alloc(),child_stack);

        Backend backend=emulator.getBackend();
        this.child_stack = child_stack;
        this.fn = (UnidbgPointer) arg.getPointer(48);
        this.arg = arg;

        if (ThreadDispatcher.lunch){

            System.err.println("LinuxThread child_stack: "+child_stack+" fn: "+this.fn+" context: "+context);
            System.out.println("当前context_alloc寄存器");
            emulator.showRegs();
            //保存当前线程的上下文
            backend.context_save(emulator.getThreadDispatcher().CurrentThreadContext());
            //修改pc和栈指针
            int cpsr = backend.reg_read(ArmConst.UC_ARM_REG_CPSR).intValue();
            cpsr=cpsr|0b1000000;
            UnidbgPointer this_arg=((UnidbgPointer) this.arg).getPointer(52);
            backend.reg_write(ArmConst.UC_ARM_REG_CPSR,cpsr);
            backend.reg_write(ArmConst.UC_ARM_REG_R0,this_arg==null?0:this_arg.peer);
            backend.reg_write(ArmConst.UC_ARM_REG_PC,this.fn.peer);
            backend.reg_write(ArmConst.UC_ARM_REG_SP,((UnidbgPointer)this.child_stack).peer);
            backend.reg_write(ArmConst.UC_ARM_REG_LR,0xffffff00L);
            //修改指令类型为thumb

            //保存到子线程
            backend.context_save(context);
            System.out.println("保存到子线程 context_alloc寄存器");
            emulator.showRegs();

            //恢复当前线程上下文
            backend.context_restore(emulator.getThreadDispatcher().CurrentThreadContext());
            System.out.println("恢复当前线程上下文 context_alloc寄存器");
            emulator.showRegs();

//            Debugger debugger= emulator.attach();
//            debugger.debug();
//            debugger.addBreakPoint(this.fn.peer);
//            emulator.getBackend().emu_start(this.fn.peer, 0, 0, 0);
        }



    }


}
